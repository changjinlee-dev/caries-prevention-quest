<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Caries Prevention Quest</title>
  <meta name="description" content="A kid-friendly web game teaching prevention for high-caries-risk children: OHI, floss, sealants, and regular dental visits." />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-sky-50">
  <div id="root"></div>

  <!-- React + Babel -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useEffect, useMemo, useRef, useState } = React;

    /* ---------- UI bits ---------- */
    const Tooth = ({ clean = false, size="w-7 h-7" }) => (
      <div className={`${size} rounded-md m-0.5 transition-colors duration-150 ${clean ? "bg-white" : "bg-yellow-300"} shadow-sm border border-gray-300`} />
    );

    const Progress = ({ value }) => (
      <div className="w-full bg-gray-200 rounded-full h-3">
        <div className="h-3 rounded-full transition-all" style={{ width: `${Math.min(100, Math.max(0, value))}%` }} />
      </div>
    );

    const Card = ({ title, children, footer }) => (
      <div className="bg-white rounded-2xl shadow-lg p-5 border border-gray-100 w-full max-w-4xl">
        <h2 className="text-xl font-semibold mb-3">{title}</h2>
        <div>{children}</div>
        {footer && <div className="mt-4 text-sm text-gray-600">{footer}</div>}
      </div>
    );

    const Button = ({ children, onClick, variant = "default", disabled }) => (
      <button
        onClick={onClick}
        disabled={disabled}
        className={`px-4 py-2 rounded-xl font-medium shadow-sm transition-all mr-2 mb-2 ${
          variant === "default"
            ? "bg-blue-600 text-white hover:bg-blue-700 disabled:bg-blue-300"
            : variant === "ghost"
            ? "bg-white border border-gray-300 hover:bg-gray-50"
            : variant === "success"
            ? "bg-emerald-600 text-white hover:bg-emerald-700"
            : "bg-slate-800 text-white hover:bg-slate-900"
        }`}
      >
        {children}
      </button>
    );

    function useTimer(active, seconds, onDone) {
      const [time, setTime] = useState(seconds);
      useEffect(() => { if (active) setTime(seconds); }, [seconds, active]);
      useEffect(() => {
        if (!active) return;
        const id = setInterval(() => {
          setTime(t => {
            if (t <= 1) { clearInterval(id); onDone?.(); return 0; }
            return t - 1;
          });
        }, 1000);
        return () => clearInterval(id);
      }, [active, onDone]);
      return time;
    }

    /* ---------- Level 1: Brush Boss (20 teeth; 2x10; exactly 10 dirty) ---------- */
    function BrushBoss({ onComplete, onFail }) {
      const cols = 10, rows = 2, total = cols * rows; // 20
      const [grid, setGrid] = useState(() => {
        const arr = Array(total).fill(false);
        let dirty = 10;
        while (dirty > 0) {
          const i = Math.floor(Math.random() * total);
          if (!arr[i]) { arr[i] = true; dirty--; }
        }
        return arr;
      });
      const needed = 10;
      const cleaned = useMemo(() => 10 - grid.filter(Boolean).length, [grid]);
      const [brushing, setBrushing] = useState(false);
      const time = useTimer(true, 30, () => onFail?.());

      const handleBrush = (idx) => {
        setGrid(g => {
          if (!g[idx]) return g;
          const copy = [...g];
          copy[idx] = false;
          return copy;
        });
      };

      useEffect(() => { if (cleaned >= needed) onComplete?.(); }, [cleaned, needed, onComplete]);

      return (
        <Card
          title="Level 1 – Brush Boss (OHI)"
          footer={<div>
            <p className="mb-1">Tip: Brush all tooth surfaces in small circles for 2 minutes, twice a day.</p>
            <p>Goal: There are <b>20 teeth</b> in <b>2 rows × 10</b> and <b>10 yellow</b>. Clean all 10 yellow teeth.</p>
          </div>}
        >
          <div className="flex items-center justify-between mb-3">
            <div className="text-sm">Time: <span className="font-semibold">{time}s</span></div>
            <div className="text-sm">Cleaned: <span className="font-semibold">{cleaned}/10</span></div>
          </div>
          <Progress value={(cleaned / 10) * 100} />
          <div
            className="select-none grid mt-3"
            style={{ gridTemplateColumns: `repeat(${cols}, minmax(0, 1fr))` }}
            onMouseDown={() => setBrushing(true)}
            onMouseUp={() => setBrushing(false)}
            onMouseLeave={() => setBrushing(false)}
            onTouchStart={() => setBrushing(true)}
            onTouchEnd={() => setBrushing(false)}
          >
            {grid.map((hasPlaque, i) => (
              <div
                key={i}
                onMouseEnter={() => brushing && handleBrush(i)}
                onMouseDown={() => handleBrush(i)}
                onTouchMove={(e) => {
                  const t = e.touches?.[0] || e.changedTouches?.[0];
                  if (!t) return;
                  const el = document.elementFromPoint(t.clientX, t.clientY);
                  if (el?.dataset?.idx) handleBrush(Number(el.dataset.idx));
                }}
                data-idx={i}
              >
                <Tooth clean={!hasPlaque} />
              </div>
            ))}
          </div>
        </Card>
      );
    }

    /* ---------- NEW Level 2: Floss Frenzy (clear interdental debris) ---------- */
    function FlossFrenzy({ onComplete, onFail }) {
      // 2 rows; 5 gaps per row (10 gaps total). 6 start with debris.
      const gapsPerRow = 5;
      const rows = 2;
      const totalGaps = gapsPerRow * rows;
      const [gaps, setGaps] = useState(() => {
        const arr = Array(totalGaps).fill(false); // false = clean gap
        let debris = 6;
        while (debris > 0) {
          const i = Math.floor(Math.random() * totalGaps);
          if (!arr[i]) { arr[i] = true; debris--; } // true = debris present
        }
        return arr;
      });
      const time = useTimer(true, 25, () => onFail?.());
      const cleared = useMemo(() => gaps.filter(v => !v).length, [gaps]);
      const needToClear = totalGaps; // must make all gaps clean

      const flossGap = (i) => setGaps(g => {
        if (!g[i]) return g; // already clean
        const copy = [...g]; copy[i] = false; return copy;
      });

      useEffect(() => {
        if (cleared === needToClear) onComplete?.();
      }, [cleared, needToClear, onComplete]);

      // little visual row with teeth and clickable narrow "gap" buttons
      const Gap = ({ dirty, onDrag }) => (
        <div
          className={`w-3 h-10 mx-1 rounded-md border transition-all ${
            dirty ? "bg-yellow-300 border-yellow-400" : "bg-white border-gray-300"
          }`}
          onMouseDown={() => onDrag()}
          onMouseEnter={(e) => (e.buttons === 1) && onDrag()}
          onTouchStart={onDrag}
        />
      );

      const Row = ({ rowIndex }) => {
        const start = rowIndex * gapsPerRow;
        // Layout: T | gap | T | gap | ... | T (we visually draw teeth blocks; gaps clickable)
        const teethCount = gapsPerRow + 1; // 6 teeth around 5 gaps
        const segments = [];
        for (let t = 0; t < teethCount; t++) {
          segments.push(<Tooth key={`t-${rowIndex}-${t}`} size="w-8 h-8" clean />);
          if (t < gapsPerRow) {
            const gi = start + t;
            segments.push(<Gap key={`g-${gi}`} dirty={gaps[gi]} onDrag={() => flossGap(gi)} />);
          }
        }
        return <div className="flex items-center justify-center my-2">{segments}</div>;
      };

      return (
        <Card
          title="Level 2 – Floss Frenzy (Interdental Cleaning)"
          footer={<div>
            <p className="mb-1">Tip: Slide the floss gently between teeth, curve around each tooth in a “C” shape, and move up & down.</p>
            <p>Goal: Clear all <b>interdental debris</b> (tap/drag on the yellow gaps). Timer is ticking!</p>
          </div>}
        >
          <div className="flex items-center justify-between mb-3">
            <div className="text-sm">Time: <span className="font-semibold">{time}s</span></div>
            <div className="text-sm">Gaps Cleaned: <span className="font-semibold">{cleared}/{totalGaps}</span></div>
          </div>
          <Progress value={(cleared / totalGaps) * 100} />
          <div className="mt-3">
            <Row rowIndex={0} />
            <Row rowIndex={1} />
          </div>
        </Card>
      );
    }

    /* ---------- Level 3: Sealant Splash (≥20% or cross) ---------- */
    function SealantSplash({ onComplete, onFail }) {
      const canvasRef = useRef(null);
      const [coveredPct, setCoveredPct] = useState(0);
      const [painting, setPainting] = useState(false);
      const time = useTimer(true, 35, () => onFail?.());

      useEffect(() => {
        const canvas = canvasRef.current;
        const ctx = canvas.getContext("2d");
        const W = canvas.width, H = canvas.height;
        ctx.clearRect(0, 0, W, H);
        ctx.fillStyle = "#ffffff";
        ctx.strokeStyle = "#cbd5e1";
        ctx.lineWidth = 3;

        // Tooth shape
        ctx.beginPath();
        ctx.moveTo(W * 0.2, H * 0.6);
        ctx.quadraticCurveTo(W * 0.2, H * 0.2, W * 0.5, H * 0.2);
        ctx.quadraticCurveTo(W * 0.8, H * 0.2, W * 0.8, H * 0.6);
        ctx.quadraticCurveTo(W * 0.8, H * 0.85, W * 0.65, H * 0.9);
        ctx.quadraticCurveTo(W * 0.5, H * 0.95, W * 0.35, H * 0.9);
        ctx.quadraticCurveTo(W * 0.2, H * 0.85, W * 0.2, H * 0.6);
        ctx.closePath(); ctx.fill(); ctx.stroke();

        // Fissures
        ctx.strokeStyle = "#64748b"; ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(W * 0.3, H * 0.5);
        ctx.bezierCurveTo(W * 0.4, H * 0.45, W * 0.6, H * 0.55, W * 0.7, H * 0.5);
        ctx.moveTo(W * 0.5, H * 0.3);
        ctx.bezierCurveTo(W * 0.5, H * 0.45, W * 0.55, H * 0.6, W * 0.5, H * 0.7);
        ctx.stroke();
      }, []);

      const computeStats = () => {
        const canvas = canvasRef.current;
        const ctx = canvas.getContext("2d");
        const W = canvas.width, H = canvas.height;
        const img = ctx.getImageData(0, 0, W, H).data;

        let blueish = 0, white = 0;
        for (let i = 0; i < img.length; i += 4 * 8) {
          const r = img[i], g = img[i + 1], b = img[i + 2], a = img[i + 3];
          if (r > 230 && g > 230 && b > 230) white++;
          if (b > 150 && r < 120 && a > 0) blueish++;
        }
        const pct = Math.min(100, Math.round((blueish / (white + blueish + 1)) * 100));

        // cross detector
        const band = 15;
        let vBlue = 0, vTotal = 0, hBlue = 0, hTotal = 0;
        for (let x = Math.floor(W/2 - band); x <= Math.floor(W/2 + band); x++) {
          for (let y = 0; y < H; y++) {
            const idx = (y * W + x) * 4;
            const r = img[idx], g = img[idx+1], b = img[idx+2], a = img[idx+3];
            if (a === 0) continue; vTotal++; if (b > 150 && r < 120) vBlue++;
          }
        }
        for (let y = Math.floor(H/2 - band); y <= Math.floor(H/2 + band); y++) {
          for (let x = 0; x < W; x++) {
            const idx = (y * W + x) * 4;
            const r = img[idx], g = img[idx+1], b = img[idx+2], a = img[idx+3];
            if (a === 0) continue; hTotal++; if (b > 150 && r < 120) hBlue++;
          }
        }
        const isCross = (vBlue/Math.max(1,vTotal)) > 0.35 && (hBlue/Math.max(1,hTotal)) > 0.35;
        return { pct, isCross };
      };

      const paint = (x, y) => {
        const canvas = canvasRef.current;
        const ctx = canvas.getContext("2d");
        ctx.globalCompositeOperation = "source-over";
        ctx.fillStyle = "rgba(59,130,246,0.6)";
        ctx.beginPath(); ctx.arc(x, y, 12, 0, Math.PI * 2); ctx.fill();

        const { pct, isCross } = computeStats();
        setCoveredPct(pct);
        if (pct >= 20 || isCross) onComplete?.();
      };

      const handlePointer = (clientX, clientY) => {
        const rect = canvasRef.current.getBoundingClientRect();
        const x = clientX - rect.left, y = clientY - rect.top;
        if (painting) paint(x, y);
      };

      return (
        <Card
          title="Level 3 – Sealant Splash"
          footer={<div>
            <p className="mb-1">Fact: Sealants protect deep grooves of molars from food and bacteria.</p>
            <p>Goal: Draw a cross through the center <b>or</b> reach <b>≥20%</b> coverage before time runs out.</p>
          </div>}
        >
          <div className="flex items-center justify-between mb-3">
            <div className="text-sm">Time: <span className="font-semibold">{time}s</span></div>
            <div className="text-sm">Coverage: <span className="font-semibold">{coveredPct}%</span></div>
          </div>
          <canvas
            ref={canvasRef}
            width={520}
            height={320}
            className="bg-white rounded-2xl border border-gray-200 touch-none"
            onMouseDown={() => setPainting(true)}
            onMouseUp={() => setPainting(false)}
            onMouseLeave={() => setPainting(false)}
            onMouseMove={(e) => handlePointer(e.clientX, e.clientY)}
            onTouchStart={() => setPainting(true)}
            onTouchEnd={() => setPainting(false)}
            onTouchMove={(e) => {
              const t = e.touches?.[0] || e.changedTouches?.[0];
              if (t) handlePointer(t.clientX, t.clientY);
            }}
          />
          <div className="mt-3 text-sm text-gray-600">Tip: Click or touch and drag to paint the blue sealant.</div>
        </Card>
      );
    }

    /* ---------- Level 4: High-risk plan (exactly 4 visits, every 3 months) ---------- */
    function CheckupChallenge({ onComplete, onFail }) {
      const [months, setMonths] = useState(Array.from({ length: 12 }, (_, i) => ({ i, appt: false })));
      const [msg, setMsg] = useState("");

      const toggleMonth = (i) => { setMonths(arr => arr.map(m => (m.i === i ? { ...m, appt: !m.appt } : m))); setMsg(""); };

      const validate = () => {
        const picks = months.filter(m => m.appt).map(m => m.i).sort((a,b) => a-b);
        if (picks.length !== 4) { setMsg("Select exactly FOUR checkups for a 3-month interval plan."); onFail?.(); return; }
        for (let k = 0; k < 4; k++) {
          const a = picks[k], b = picks[(k+1)%4];
          const diff = (b - a + 12) % 12;
          if (diff !== 3) { setMsg("Intervals must be exactly 3 months apart."); onFail?.(); return; }
        }
        setMsg("Great plan! Four visits, each 3 months apart.");
        onComplete?.();
      };

      return (
        <Card
          title="Level 4 – Checkup Challenge (High-risk = every 3 months)"
          footer={<div>
            <p className="mb-1">Goal: Select <b>exactly four</b> checkups spaced <b>every 3 months</b> (e.g., Jan/Apr/Jul/Oct), then submit.</p>
            <p>Tip: Regular 3-month recalls help with fluoride, sealants, and early detection.</p>
          </div>}
        >
          <div className="grid grid-cols-3 sm:grid-cols-4 gap-2">
            {months.map((m) => (
              <button
                key={m.i}
                onClick={() => toggleMonth(m.i)}
                className={`h-20 rounded-2xl border flex items-center justify-center text-lg font-semibold transition-all ${
                  m.appt ? "bg-emerald-100 border-emerald-400" : "bg-white border-gray-200 hover:bg-gray-50"
                }`}
                aria-label={`Month ${m.i + 1}${m.appt ? " appointment set" : ""}`}
              >
                {new Date(2025, m.i, 1).toLocaleString(undefined, { month: "short" })}
                {m.appt && <span className="ml-2">🦷</span>}
              </button>
            ))}
          </div>
          <div className="mt-4 flex items-center">
            <Button onClick={validate}>Submit Plan</Button>
            {msg && <span className="ml-3 text-sm">{msg}</span>}
          </div>
        </Card>
      );
    }

    const FactBanner = ({ text }) => (
      <div className="bg-amber-50 border border-amber-200 text-amber-900 p-3 rounded-xl text-sm">{text}</div>
    );

    function CariesPreventionGame() {
      const [level, setLevel] = useState(0);
      const [score, setScore] = useState(0);
      const [showHowTo, setShowHowTo] = useState(true);
      const next = () => setLevel(l => l + 1);

      return (
        <div className="min-h-screen w-full bg-gradient-to-b from-sky-50 to-white flex flex-col items-center px-4 py-8">
          <div className="w-full max-w-4xl flex items-center justify-between mb-6">
            <h1 className="text-2xl sm:text-3xl font-bold tracking-tight">Caries Prevention Quest</h1>
            <div className="text-sm text-gray-600">Score: <span className="font-semibold">{score}</span></div>
          </div>

          {showHowTo && (
            <Card title="How to Play">
              <ul className="list-disc ml-6 text-sm text-gray-700 space-y-1">
                <li><b>Brush Boss:</b> 20 teeth (2×10). Clean the 10 yellow ones.</li>
                <li><b>Floss Frenzy:</b> Clear all interdental debris by dragging/tapping the yellow gaps.</li>
                <li><b>Sealant Splash:</b> Draw a cross through the center or reach ≥20% coverage.</li>
                <li><b>Checkup Challenge:</b> High-risk = exactly four visits, every 3 months.</li>
              </ul>
              <div className="mt-4"><Button onClick={() => setShowHowTo(false)} variant="success">Start</Button></div>
            </Card>
          )}

          {!showHowTo && level === 0 && (
            <BrushBoss
              onComplete={() => { setScore(s => s + 100); next(); }}
              onFail={() => { setScore(s => Math.max(0, s - 20)); next(); }}
            />
          )}

          {level === 1 && (
            <div className="w-full flex flex-col items-center gap-4">
              <FactBanner text="Floss once a day. Slide between teeth, curve around each tooth in a “C” shape, and move up & down." />
              <FlossFrenzy
                onComplete={() => { setScore(s => s + 100); next(); }}
                onFail={() => { setScore(s => Math.max(0, s - 20)); next(); }}
              />
            </div>
          )}

          {level === 2 && (
            <div className="w-full flex flex-col items-center gap-4">
              <FactBanner text="Sealants coat the deep grooves of molars and can dramatically reduce cavities." />
              <SealantSplash
                onComplete={() => { setScore(s => s + 120); next(); }}
                onFail={() => { setScore(s => Math.max(0, s - 20)); next(); }}
              />
            </div>
          )}

          {level === 3 && (
            <div className="w-full flex flex-col items-center gap-4">
              <FactBanner text="High-risk children often need recall every 3 months for fluoride, sealants, and early detection." />
              <CheckupChallenge
                onComplete={() => { setScore(s => s + 80); next(); }}
                onFail={() => { setScore(s => Math.max(0, s - 20)); }}
              />
            </div>
          )}

          {level >= 4 && (
            <Card title="You Did It!">
              <p className="text-gray-700">
                You mastered <b>brushing</b>, <b>flossing</b>, <b>sealants</b>, and <b>regular checkups</b>.
              </p>
              <ul className="list-disc ml-6 mt-3 text-gray-700 text-sm">
                <li>Brush 2×/day for 2 minutes with fluoride toothpaste.</li>
                <li>Floss once a day to clean where brushes can’t reach.</li>
                <li>Ask about sealants for new molars.</li>
                <li>High-risk recall: every 3 months.</li>
              </ul>
              <div className="mt-4 flex items-center">
                <Button onClick={() => { window.location.reload(); }}>Play Again</Button>
                <Button variant="ghost" onClick={() => window.print()}>Print Tips</Button>
              </div>
            </Card>
          )}

          <footer className="mt-8 text-xs text-gray-500">WesternU Dental Medicine.</footer>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<CariesPreventionGame />);
  </script>
</body>
</html>
